<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - ProjectCollab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style> 
        .container { margin-top: 50px; } 
        body { background-color: #f8f9fa; }
        .card { border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { border-radius: 5px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">ProjectCollab</a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#profileModal">Profile</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <h2>Your Dashboard</h2>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="search-projects" placeholder="Search projects..." oninput="loadProjects()">
            <button class="btn btn-outline-secondary" onclick="loadProjects()">Search</button>
        </div>
        <div id="projects-list" class="row"></div>
        <h3 class="mt-4">Create New Project</h3>
        <form>
            <div class="mb-3">
                <label for="new-project-name" class="form-label">Name</label>
                <input type="text" class="form-control" id="new-project-name">
            </div>
            <div class="mb-3">
                <label for="new-project-desc" class="form-label">Description</label>
                <textarea class="form-control" id="new-project-desc"></textarea>
            </div>
            <button type="button" class="btn btn-primary" onclick="handleCreateProject()">Create</button>
            <button type="button" class="btn btn-success ms-2" onclick="window.location.href='checkout.html?type=subscribe'">Subscribe (Create up to 20 Projects)</button>
        </form>
        <button class="btn btn-secondary mt-3" onclick="window.location.href='trash.html'">View Trash</button>
        <button class="btn btn-warning mt-3" onclick="resetLab()">Reset Data (For Testing)</button>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bio" class="form-label">Bio</label>
                        <textarea class="form-control" id="bio"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password (optional)</label>
                        <input type="password" class="form-control" id="newPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updateProfile()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location = 'login.html';

        async function apiCall(url, method = 'GET', body = null) {
            const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            const response = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null });
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location = 'login.html';
            }
            return response.json();
        }

        async function loadProjects() {
            const search = document.getElementById('search-projects').value.toLowerCase();
            const projects = await apiCall('/api/projects');
            const list = document.getElementById('projects-list');
            list.innerHTML = '';
            projects.filter(p => p.name.toLowerCase().includes(search) || p.description.toLowerCase().includes(search)).forEach(p => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-3';
                card.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">${p.name}</h5>
                            <p class="card-text">${p.description}</p>
                            <a href="project.html?id=${p.id}" class="btn btn-primary">View Project</a>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        async function handleCreateProject() {
            const name = document.getElementById('new-project-name').value;
            const description = document.getElementById('new-project-desc').value;
            const response = await apiCall('/api/projects', 'POST', { name, description }).catch(e => e);
            if (response.message === 'Project limit reached. Subscribe to create more.') {
                if (confirm('Project limit reached. Subscribe now?')) window.location = 'checkout.html?type=subscribe';
            } else {
                loadProjects();
            }
        }

        async function updateProfile() {
            const bio = document.getElementById('bio').value;
            const newPassword = document.getElementById('newPassword').value;
            await apiCall('/api/users/me', 'PUT', { bio, newPassword });
            alert('Profile updated');
            bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
        }

        async function logout() {
            await apiCall('/api/logout', 'POST');
            localStorage.removeItem('token');
            window.location = 'login.html';
        }

        async function resetLab() {
            if (confirm('Reset all data?')) {
                await fetch('/api/reset', { method: 'POST' });
                alert('Data reset');
                loadProjects();
            }
        }

        async function loadProfile() {
            const profile = await apiCall('/api/users/me');
            document.getElementById('bio').value = profile.bio;
        }

        loadProjects();
        loadProfile();
    </script>
</body>
</html>