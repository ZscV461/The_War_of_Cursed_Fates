<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Project - ProjectCollab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .container { margin-top: 50px; }
        .hidden { display: none; }
        .tab-content { margin-top: 20px; }
        .action-btn { margin-bottom: 10px; }
        .notification-badge { position: absolute; top: 0; right: 0; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">ProjectCollab</a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item position-relative">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                        <i class="fas fa-bell"></i>
                        <span id="notification-count" class="badge bg-danger notification-badge hidden">0</span>
                    </a>
                </li>
                <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 id="project-name"></h2>
                <p id="project-desc"></p>
                <p>Your Role: <span id="user-role"></span></p>
            </div>
            <div>
                <button class="btn btn-info" onclick="checkProgress()">Check Progress</button>
            </div>
        </div>

        <div id="role-upgrade-section" class="card mb-4">
            <div class="card-body">
                <h5>Manage Your Role</h5>
                <button id="upgrade-to-commenter" class="btn btn-info me-2" onclick="upgradeToCommenter()">Upgrade to Commenter (Free)</button>
                <button id="pay-for-admin" class="btn btn-warning me-2" onclick="payForAdminUpgrade()">Pay $100 for Admin Upgrade</button>
                <button id="upgrade-to-admin" class="btn btn-success me-2 hidden" onclick="upgradeToAdmin()">Upgrade to Admin</button>
            </div>
        </div>

        <ul class="nav nav-tabs" id="projectTabs">
            <li class="nav-item"><a class="nav-link active" href="#overview">Overview</a></li>
            <li class="nav-item"><a class="nav-link" href="#members">Members</a></li>
            <li class="nav-item"><a class="nav-link" href="#notes">Notes</a></li>
            <li class="nav-item"><a class="nav-link" href="#tasks">Tasks</a></li>
            <li class="nav-item"><a class="nav-link" href="#files">Files</a></li>
            <li class="nav-item"><a class="nav-link" href="#activity">Activity</a></li>
            <li class="nav-item"><a class="nav-link" href="#settings">Settings</a></li>
        </ul>

        <div class="tab-content">
            <div id="overview" class="tab-pane active">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5>Project Statistics</h5>
                        <ul id="project-stats"></ul>
                    </div>
                </div>
            </div>

            <div id="members" class="tab-pane">
                <div id="admin-members-section" class="card mb-4 hidden">
                    <div class="card-body">
                        <h5>Manage Members</h5>
                        <button class="btn btn-primary action-btn" data-bs-toggle="modal" data-bs-target="#addMemberModal">Add New Member</button>
                        <table class="table table-striped">
                            <thead>
                                <tr><th>User ID</th><th>Username</th><th>Role</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="members-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="notes" class="tab-pane">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5>Notes</h5>
                        <button id="add-note-btn" class="btn btn-primary action-btn hidden" data-bs-toggle="modal" data-bs-target="#addNoteModal">Add New Note</button>
                        <div id="notes-list" class="accordion"></div>
                    </div>
                </div>
            </div>

            <div id="tasks" class="tab-pane">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5>Tasks</h5>
                        <button id="add-task-btn" class="btn btn-primary action-btn hidden" data-bs-toggle="modal" data-bs-target="#addTaskModal">Add New Task</button>
                        <div id="tasks-list" class="accordion"></div>
                    </div>
                </div>
            </div>

            <div id="files" class="tab-pane">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5>Files</h5>
                        <button id="upload-file-btn" class="btn btn-primary action-btn hidden" data-bs-toggle="modal" data-bs-target="#uploadFileModal">Upload File</button>
                        <table class="table table-striped">
                            <thead>
                                <tr><th>Name</th><th>Uploaded By</th><th>Date</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="files-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="activity" class="tab-pane">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5>Project Activity</h5>
                        <ul id="activity-list" class="list-group"></ul>
                    </div>
                </div>
            </div>

            <div id="settings" class="tab-pane">
                <div id="admin-settings-section" class="card mb-4 hidden">
                    <div class="card-body">
                        <h5>Project Settings</h5>
                        <div class="mb-3">
                            <label for="edit-project-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="edit-project-name">
                        </div>
                        <div class="mb-3">
                            <label for="edit-project-desc" class="form-label">Description</label>
                            <textarea class="form-control" id="edit-project-desc"></textarea>
                        </div>
                        <button class="btn btn-primary me-2" onclick="handleUpdateProject()">Update</button>
                        <button class="btn btn-danger" onclick="handleDeleteProject()">Delete Project</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="search-user" placeholder="Search User by Username" oninput="searchUsers()">
                        <button class="btn btn-outline-secondary" onclick="searchUsers()">Search</button>
                    </div>
                    <div id="user-search-results" class="list-group mb-3"></div>
                    <div class="mb-3">
                        <label for="add-user-id" class="form-label">User ID</label>
                        <input type="number" class="form-control" id="add-user-id">
                    </div>
                    <div class="mb-3">
                        <label for="add-user-role" class="form-label">Role</label>
                        <select class="form-control" id="add-user-role">
                            <option value="viewer">Viewer</option>
                            <option value="commenter">Commenter</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="handleAddMember()" data-bs-dismiss="modal">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div class="modal fade" id="addNoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="new-note-content" placeholder="Note Content"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="handleAddNote()" data-bs-dismiss="modal">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Note Modal -->
    <div class="modal fade" id="editNoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="edit-note-content"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="edit-note-btn" data-bs-dismiss="modal">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-task-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="new-task-title">
                    </div>
                    <div class="mb-3">
                        <label for="new-task-desc" class="form-label">Description</label>
                        <textarea class="form-control" id="new-task-desc"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="new-task-assigned" class="form-label">Assigned To (User ID)</label>
                        <input type="number" class="form-control" id="new-task-assigned">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="handleAddTask()" data-bs-dismiss="modal">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit-task-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="edit-task-title">
                    </div>
                    <div class="mb-3">
                        <label for="edit-task-desc" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-task-desc"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit-task-status" class="form-label">Status</label>
                        <select class="form-control" id="edit-task-status">
                            <option value="pending">Pending</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-task-assigned" class="form-label">Assigned To (User ID)</label>
                        <input type="number" class="form-control" id="edit-task-assigned">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="edit-task-btn" data-bs-dismiss="modal">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload File Modal -->
    <div class="modal fade" id="uploadFileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-file-name" class="form-label">File Name</label>
                        <input type="text" class="form-control" id="new-file-name">
                    </div>
                    <div class="mb-3">
                        <label for="new-file-content" class="form-label">Content</label>
                        <textarea class="form-control" id="new-file-content"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="handleUploadFile()" data-bs-dismiss="modal">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div class="modal fade" id="notificationsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Notifications</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul id="notifications-list" class="list-group"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location = 'login.html';
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = parseInt(urlParams.get('id'));
        let currentUserId;

        async function apiCall(url, method = 'GET', body = null) {
            const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            const response = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : null });
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location = 'login.html';
            }
            return response.json();
        }

        async function loadProject() {
            const project = await apiCall(`/api/projects/${projectId}`);
            document.getElementById('project-name').innerText = project.name;
            document.getElementById('project-desc').innerText = project.description;
            document.getElementById('edit-project-name').value = project.name;
            document.getElementById('edit-project-desc').value = project.description;

            const me = await apiCall('/api/users/me');
            currentUserId = me.id;

            const access = await apiCall(`/api/projects/${projectId}/access`);
            const isAdmin = access._is_admin.value === 'true';
            const isPurchased = access._is_purchased.value === 'true';

            const hasAdminPriv = isAdmin;
            const purchased = isPurchased;

            let role = project.creator_id === currentUserId ? 'admin' : project.members.find(m => m.user_id === currentUserId)?.role || 'viewer';
            document.getElementById('user-role').innerText = role;

            updateUI(hasAdminPriv, purchased, role);
            loadStats();
            loadMembers(project.members, hasAdminPriv);
            loadNotes(project.notes, role, hasAdminPriv);
            loadTasks(project.tasks, role, hasAdminPriv);
            loadFiles(project.files, hasAdminPriv);
            loadActivity(project.activity);
            loadNotifications();

            const tabs = document.querySelectorAll('#projectTabs a');
            tabs.forEach(tab => {
                tab.addEventListener('click', function (e) {
                    e.preventDefault();
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    document.querySelector(this.getAttribute('href')).classList.add('active');
                });
            });
        }

        function updateUI(hasAdminPriv, purchased, role) {
            document.getElementById('role-upgrade-section').classList.toggle('hidden', role === 'admin' || hasAdminPriv);
            document.getElementById('upgrade-to-commenter').classList.toggle('hidden', role !== 'viewer');
            document.getElementById('pay-for-admin').classList.toggle('hidden', purchased);
            document.getElementById('upgrade-to-admin').classList.toggle('hidden', !purchased);
            document.getElementById('admin-members-section').classList.toggle('hidden', !hasAdminPriv);
            document.getElementById('add-note-btn').classList.toggle('hidden', !hasAdminPriv);
            document.getElementById('add-task-btn').classList.toggle('hidden', !hasAdminPriv);
            document.getElementById('upload-file-btn').classList.toggle('hidden', !hasAdminPriv);
            document.getElementById('admin-settings-section').classList.toggle('hidden', !hasAdminPriv);
        }

        async function loadStats() {
            const stats = await apiCall(`/api/projects/${projectId}/stats`);
            document.getElementById('project-stats').innerHTML = `
                <li>Members: ${stats.membersCount}</li>
                <li>Notes: ${stats.notesCount}</li>
                <li>Tasks: ${stats.tasksCount}</li>
                <li>Files: ${stats.filesCount}</li>
                <li>Activity Logs: ${stats.activityCount}</li>
            `;
        }

        async function searchUsers() {
            const q = document.getElementById('search-user').value;
            if (q.length < 3) return;
            const users = await apiCall(`/api/users/search?q=${q}`);
            const results = document.getElementById('user-search-results');
            results.innerHTML = '';
            users.forEach(u => {
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                item.innerText = `${u.username} (ID: ${u.id})`;
                item.onclick = () => {
                    document.getElementById('add-user-id').value = u.id;
                    results.innerHTML = '';
                    document.getElementById('search-user').value = '';
                };
                results.appendChild(item);
            });
        }

        async function loadMembers(members, hasAdminPriv) {
            const tbody = document.getElementById('members-list');
            tbody.innerHTML = '';
            for (const m of members) {
                const user = await apiCall('/api/users/me'); // Placeholder, ideally fetch username
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m.user_id}</td>
                    <td>User${m.user_id}</td>
                    <td>${m.role}</td>
                    <td>${hasAdminPriv ? `<button class="btn btn-danger btn-sm" onclick="handleRemoveMember(${m.user_id})">Remove</button>` : ''}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function loadNotes(notes, role, hasAdminPriv) {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';
            notes.forEach((note, index) => {
                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                accordionItem.innerHTML = `
                    <h2 class="accordion-header" id="noteHeading${index}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#noteCollapse${index}">
                            Note #${note.id}: ${note.content.substring(0, 50)}... (${new Date(note.created_at).toLocaleString()})
                        </button>
                    </h2>
                    <div id="noteCollapse${index}" class="accordion-collapse collapse" data-bs-parent="#notes-list">
                        <div class="accordion-body">
                            <p>${note.content}</p>
                            <h6>Comments:</h6>
                            <ul>${note.comments.map(c => `<li>User ${c.user_id}: ${c.text} (${new Date(c.timestamp).toLocaleString()})</li>`).join('')}</ul>
                            ${(role === 'commenter' || hasAdminPriv) ? `
                                <div class="input-group mt-2">
                                    <input type="text" class="form-control" placeholder="Add Comment" id="comment-note-${note.id}">
                                    <button class="btn btn-outline-secondary" onclick="handleAddComment(${note.id}, document.getElementById('comment-note-${note.id}').value, 'notes')">Add</button>
                                </div>
                            ` : ''}
                            ${hasAdminPriv ? `
                                <div class="mt-2">
                                    <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" data-bs-target="#editNoteModal" onclick="setEditNote(${note.id}, '${note.content.replace(/'/g, "\\'")}')">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="handleDeleteNote(${note.id})">Delete</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(accordionItem);
            });
        }

        function loadTasks(tasks, role, hasAdminPriv) {
            const list = document.getElementById('tasks-list');
            list.innerHTML = '';
            tasks.forEach((task, index) => {
                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                accordionItem.innerHTML = `
                    <h2 class="accordion-header" id="taskHeading${index}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#taskCollapse${index}">
                            Task #${task.id}: ${task.title} (${task.status}, Created: ${new Date(task.created_at).toLocaleString()})
                        </button>
                    </h2>
                    <div id="taskCollapse${index}" class="accordion-collapse collapse" data-bs-parent="#tasks-list">
                        <div class="accordion-body">
                            <p>${task.description}</p>
                            <p>Assigned to: ${task.assigned_to || 'Unassigned'}</p>
                            <h6>Comments:</h6>
                            <ul>${task.comments.map(c => `<li>User ${c.user_id}: ${c.text} (${new Date(c.timestamp).toLocaleString()})</li>`).join('')}</ul>
                            ${(role === 'commenter' || hasAdminPriv) ? `
                                <div class="input-group mt-2">
                                    <input type="text" class="form-control" placeholder="Add Comment" id="comment-task-${task.id}">
                                    <button class="btn btn-outline-secondary" onclick="handleAddComment(${task.id}, document.getElementById('comment-task-${task.id}').value, 'tasks')">Add</button>
                                </div>
                            ` : ''}
                            ${hasAdminPriv ? `
                                <div class="mt-2">
                                    <button class="btn btn-warning btn-sm me-2" data-bs-toggle="modal" data-bs-target="#editTaskModal" onclick="setEditTask(${task.id}, '${task.title.replace(/'/g, "\\'")}', '${task.description.replace(/'/g, "\\'")}', '${task.status}', ${task.assigned_to || null})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="handleDeleteTask(${task.id})">Delete</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(accordionItem);
            });
        }

        function loadFiles(files, hasAdminPriv) {
            const tbody = document.getElementById('files-list');
            tbody.innerHTML = '';
            files.forEach(f => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${f.name}</td>
                    <td>User ${f.uploaded_by}</td>
                    <td>${new Date(f.created_at).toLocaleString()}</td>
                    <td>${hasAdminPriv ? `<button class="btn btn-danger btn-sm" onclick="handleDeleteFile(${f.id})">Delete</button>` : ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function loadActivity(activity) {
            const list = document.getElementById('activity-list');
            list.innerHTML = '';
            activity.forEach(a => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.innerHTML = `${a.message} (${new Date(a.timestamp).toLocaleString()})`;
                list.appendChild(li);
            });
        }

        async function loadNotifications() {
            const notifications = await apiCall('/api/notifications');
            const list = document.getElementById('notifications-list');
            list.innerHTML = '';
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-count');
            badge.innerText = unreadCount;
            badge.classList.toggle('hidden', unreadCount === 0);
            notifications.forEach(n => {
                const li = document.createElement('li');
                li.className = `list-group-item ${n.read ? '' : 'list-group-item-warning'}`;
                li.innerHTML = `${n.message} (${new Date(n.timestamp).toLocaleString()})`;
                if (!n.read) {
                    li.onclick = async () => {
                        await apiCall(`/api/notifications/${n.id}/read`, 'PUT');
                        loadNotifications();
                    };
                }
                list.appendChild(li);
            });
        }

        async function upgradeToCommenter() {
            await apiCall(`/api/projects/${projectId}/role`, 'POST', { new_role: 'commenter' });
            loadProject();
        }

        async function payForAdminUpgrade() {
            await apiCall(`/api/projects/${projectId}/pay`, 'POST');
            loadProject();
        }

        async function upgradeToAdmin() {
            await apiCall(`/api/projects/${projectId}/role`, 'POST', { new_role: 'admin' });
            loadProject();
        }

        async function handleAddMember() {
            const userId = document.getElementById('add-user-id').value;
            const role = document.getElementById('add-user-role').value;
            if (userId) {
                await apiCall(`/api/projects/${projectId}/members`, 'POST', { userId, role });
                loadProject();
            }
        }

        async function handleRemoveMember(userId) {
            if (confirm('Remove member?')) {
                await apiCall(`/api/projects/${projectId}/members/${userId}`, 'DELETE');
                loadProject();
            }
        }

        async function handleAddNote() {
            const content = document.getElementById('new-note-content').value;
            if (content) {
                await apiCall(`/api/projects/${projectId}/notes`, 'POST', { content });
                loadProject();
            }
        }

        async function handleDeleteNote(noteId) {
            if (confirm('Delete note?')) {
                await apiCall(`/api/projects/${projectId}/notes/${noteId}`, 'DELETE');
                loadProject();
            }
        }

        async function handleAddTask() {
            const title = document.getElementById('new-task-title').value;
            const description = document.getElementById('new-task-desc').value;
            const assigned_to = document.getElementById('new-task-assigned').value || null;
            if (title) {
                await apiCall(`/api/projects/${projectId}/tasks`, 'POST', { title, description, assigned_to });
                loadProject();
            }
        }

        async function handleDeleteTask(taskId) {
            if (confirm('Delete task?')) {
                await apiCall(`/api/projects/${projectId}/tasks/${taskId}`, 'DELETE');
                loadProject();
            }
        }

        async function handleUploadFile() {
            const name = document.getElementById('new-file-name').value;
            const content = document.getElementById('new-file-content').value;
            if (name && content) {
                await apiCall(`/api/projects/${projectId}/files`, 'POST', { name, content });
                loadProject();
            }
        }

        async function handleDeleteFile(fileId) {
            if (confirm('Delete file?')) {
                await apiCall(`/api/projects/${projectId}/files/${fileId}`, 'DELETE');
                loadProject();
            }
        }

        async function handleUpdateProject() {
            const name = document.getElementById('edit-project-name').value;
            const description = document.getElementById('edit-project-desc').value;
            await apiCall(`/api/projects/${projectId}`, 'PUT', { name, description });
            loadProject();
        }

        async function handleDeleteProject() {
            if (confirm('Delete entire project? This cannot be undone.')) {
                await apiCall(`/api/projects/${projectId}`, 'DELETE');
                window.location = 'dashboard.html';
            }
        }

        async function handleAddComment(id, text, type) {
            if (text) {
                await apiCall(`/api/projects/${projectId}/${type}/${id}/comments`, 'POST', { text });
                loadProject();
            }
        }

        function setEditNote(noteId, content) {
            document.getElementById('edit-note-content').value = content;
            document.getElementById('edit-note-btn').onclick = async () => {
                const newContent = document.getElementById('edit-note-content').value;
                await apiCall(`/api/projects/${projectId}/notes/${noteId}`, 'PUT', { content: newContent });
                loadProject();
            };
        }

        function setEditTask(taskId, title, description, status, assigned_to) {
            document.getElementById('edit-task-title').value = title;
            document.getElementById('edit-task-desc').value = description;
            document.getElementById('edit-task-status').value = status;
            document.getElementById('edit-task-assigned').value = assigned_to;
            document.getElementById('edit-task-btn').onclick = async () => {
                const newTitle = document.getElementById('edit-task-title').value;
                const newDesc = document.getElementById('edit-task-desc').value;
                const newStatus = document.getElementById('edit-task-status').value;
                const newAssigned = document.getElementById('edit-task-assigned').value || null;
                await apiCall(`/api/projects/${projectId}/tasks/${taskId}`, 'PUT', { title: newTitle, description: newDesc, status: newStatus, assigned_to: newAssigned });
                loadProject();
            };
        }

        async function checkProgress() {
            const progress = await apiCall('/api/progress');
            if (progress.step === 1) {
                alert('Progress: 1/2 - Advanced access achieved.');
            } else if (progress.step === 2) {
                alert('Progress: 2/2 - Full scenario completed. Congratulations!');
            } else {
                alert('Progress: 0/2 - Keep exploring.');
            }
        }

        async function logout() {
            await apiCall('/api/logout', 'POST');
            localStorage.removeItem('token');
            window.location = 'login.html';
        }

        loadProject();
    </script>
</body>
</html>